{% extends 'gl4app/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Add your current stock items{% endblock %}

{% block title2 %}Add your current stock items{% endblock %}

{% block description %}{% endblock %}

{% block head %}
<style>
  .wrapper {  }

  .stock-add { margin: 0; padding: 15px; }
  .stock-add > a { font-size: 1.25em; }
  .stock-add.selected { background: #EEF; }
  .stock-add > form { display: none; }
  .stock-add.selected > form { display: block; }
  .stock-add > form select { width: 350px; }

  .stock-add > form .two-cols { display: flex; }
  .stock-add > form .two-cols .left { width: 50%; margin-right: 20px; }
  .stock-add > form .two-cols .right { width: 50%; margin-left: 20px; }

  .stock-add .dim-type-total {  }
  .stock-add .dim-type-total div.form-group { display: inline-block; width: 150px; vertical-align: top; }
  .stock-add .dim-type-total label { white-space: nowrap; }
  .stock-add .dim-type-total div select { width: 100%; }
  .stock-add .dim-type-total div#div_id_dim_type { width: 140px; }
  .stock-add .dim-type-total div#div_id_dim_total { width: 100px; }
  .stock-add .dim-type-total div#div_id_dim_unit { width: 130px; }

  .stock-add textarea[name="description"] { width: 100%; height: 100px; }

  .list { background: transparent; margin: 0; padding: 0; }
  .list > .item { margin: 0; padding: 10px 5px; border-top: 1px solid #CCC; }
  .list > .item.selected { background: #EEF; }
  .list > .item > div { margin: 5px 0; }
  .list > .item > div > .tt { font-weight: bold; }
  .list > .item > .line-date { font-size: 1.15em; }
  .list > .item > .line-stones {  }
  .list > .item > .line-pics {  }
  .list > .item > .line-pics img { width: 50px; height: 50px; margin: 4px 4px 4px 0; padding: 3px; background: white; border: 1px solid #CCC; box-shadow: 1px 1px 2px rgba(0,0,0,0.28); }
  .list > .item > .line-descr { color: gray; }

  .select2-result-stones { display: block; text-align: left; height: 30px; overflow: hidden; white-space: nowrap; }
  .select2-result-stones .pic { display: inline-block; }
  .select2-result-stones .pic img { width: 200px; height: 30px; border: 0; background: gray; }
  .select2-result-stones .names { display: inline-block; }
  .select2-result-stones .names .name { display: inline; }
  .select2-result-stones .names .pseu { display: inline; color: gray; }

  .pic-item-list { padding: 10px 0; }
  .pic-item-list > .none { line-height: 50px; text-align: center; }
  .pic-item-list > .item { display: inline-block; margin: 0 5px 5px 0; position: relative; }
  .pic-item-list > .item img { padding: 5px; background: white; border: 1px solid #CCC; box-shadow: 1px 1px 3px rgba(0,0,0,0.28); width: 100px; height: 100px; }
  .pic-item-list > .item .del { background: rgba(0,0,0,0.28); color: black; font-size: 40px; text-shadow: 0 0 2px rgba(255,255,255,0.82); line-height: 100px; padding: 0; width: 100px; height: 100px; text-align: center; position: absolute; top: 0; right: 0; bottom: 0; left: 0; opacity: 0; }
  .pic-item-list > .item:hover .del { opacity: 1; cursor: pointer; }
</style>
{% endblock %}

{% block body_classes %}user settings stock{% endblock %}

{% block breadcrumb %}
<a href="{% url 'companydb_home' %}">Natural Stone Company Directory</a> &raquo;
<a href="{% url 'companydb_item' user.username %}">{{user.profile.name}}</a> &raquo;
<a href="{% url 'companydb_dashboard' %}">Dashboard</a> &raquo;
<a href="{% url 'companydb_db_stock' %}">Current stock items</a> &raquo;
{% endblock %}

{% block main %}

<div class="wrapper">
  <h1>Current stock items of {{ view_user.profile.name }}</h1>
  <div class="stock-add {% if stock %} selected {% endif %}">
    <a href="#add-stock-item">add stock</a>

    <form id="id_company-stock-form" method="post" >{% csrf_token %}
      <div class="two-cols">
        <div class="left">
          <div id="div_id_stone" class="form-group">
            <label for="id_stone" class="control-label  requiredField">
              Stone in stock<span class="asteriskField">*</span>
            </label>
            <div class="controls ">
              <select class="form-control" id="id_stone" name="stone">
                {% if stockitem %}
                <option selected="selected" value="{{ stockitem.stone.id }}">{{ stockitem.stone.name }}</option>
                {% endif %}
              </select>
              <p id="hint_id_stones" class="help-block">Start typing the name of the stone, then select it from the list.</p>
            </div>
          </div>

          <div class="dim-type-total">
            {{ form.dim_type|as_crispy_field }}
            {{ form.dim_total|as_crispy_field }}

            <div id="div_id_dim_unit" class="form-group">
              <label for="id_dim_unit" class="control-label ">
                  Unit
              </label>
              <div class="controls ">
                <select class="select form-control" id="id_dim_unit" name="dim_unit">
                  <option value="0" selected="selected">square meter</option>
                  <option value="1">square foot</option>
                  <option value="2">cubic meter</option>
                  <option value="3">cubic foot</option>
                </select>
                <p id="hint_id_dim_unit" class="help-block">Select a unit of measurement.</p>
              </div>
            </div>
          </div>

        </div>
        <div class="right">

          {{ form.description|as_crispy_field }}

          <div id="div_id_pics" class="form-group multi-pic-upload-field">
            <label for="id_pic_upload_field" class="control-label">
              Attach pictures
            </label>
            <div class="controls ">
              <div class="pic-upload-field">
                <input type="file" id="id_pic_upload_field">
                <span class="loading" style="display:none"><span></span><span></span><span></span></span>
              </div>
              <div class="pic-item-list">
                {% for x in stockitem.get_pics_list %}
                <div class="item" id="id_pics_{{x.id}}" data-url="{% url 'companydb_pic_item' x.id %}">
                  <input style="display: none;" type="checkbox" checked="checked" name="pics" value="{{ x.id }}">
                  <img src="{{ x.url_thumb }}" alt="">
                  <div class="del">X</div>
                </div>
                {% empty %}
                <div class="none">no pictures</div>
                {% endfor %}
              </div>
              <p id="hint_id_pics" class="help-block">Upload up to 20 pictures of this project.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <div class="controls ">
          <input type="submit" name="save" value="Save" class="btn btn-primary" id="submit-id-save" />
        </div>
      </div>

    </form>
  </div>

  <div class="list">
    {% for item in stocklist %}
    <div class="item {% if item.id == stockitem.id %} selected {% endif %}">
      <div class="line-date">
        <span class="tt">Last updated:</span>
        {{ item.created }} --
        <a href="{% url 'companydb_stock' user.username %}#{{ item.id }}">view</a> --
        <a href="{% url 'companydb_db_stock_item' item.id %}">edit</a>
      </div>
      <div class="line-stones">
        <span class="tt">Stones:</span>
        {% for x in item.get_stones_list %}{{ x.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
      </div>
      <div class="line-pics">
        {% for x in item.get_pics_list %}
        {% if forloop.counter < 8 %}<img src="{{ x.url_thumb }}" alt="">{% endif %}
        {% endfor %}
      </div>
      <div class="line-descr">
        {{ item.description|truncatewords:32 }}
      </div>
    </div>
    {% endfor %}
  </div>
</div>

{% endblock %}


{% block foot %}

<script>

$('a[href="#add-stock-item"]').on('click', function(ev){
  ev.preventDefault();
  $('.stock-add').toggleClass('selected');
});

$( '#id_company-stock-form' ).on( 'submit', function( ev ){
  if( ! $( '#id_description' ).val() ) {
    alert('Please provide a short description of the stock item.');
    ev.preventDefault();
  }
});

function item_del_onclick(ev){
  var oItem = $(this).parents('.item');
  console.log( $(oItem) );

  if( confirm( 'Delete this picture?' ) ) {
    // stored on server, so make sure it was intentional click
    var postUrl = $(oItem).data('url');
    if( ! postUrl ) { alert('No post URL!'); return; }
    var csrfToken = Cookies.get("csrftoken");

    console.log('csrf token: ', csrfToken);
    console.log('postUrl: ', postUrl);

    $.ajax({
      url: postUrl,
      type: 'post',
      dataType: 'json',
      data: {
        _method: 'DELETE',
	      module: "stock",
        csrfmiddlewaretoken: csrfToken,
      },
      success: function( json ) {
        $(oItem).fadeOut(200);
        setTimeout(function(){ $(oItem).remove(); }, 200);
        console.log( 'SUCCESS.', json );
      },
      error: function( xhr, status, errorThrown ) {
        console.log( 'ERROR.', xhr, status );
      },
      complete: function( xhr, status ) {
        console.log('COMPLETE.');
      },
    });
  }
}

$('.pic-item-list > .item .del').on('click', item_del_onclick);

$('#id_pic_upload_field').on('change', function(ev){ // Upload pic when file field changes.
  ev.preventDefault();
  ev.stopPropagation();

  var postUrl = "{% url 'companydb_db_pics' %}";
  var file_data = $(this).prop("files")[0];
	var form_data = new FormData();
  var oPicItemList = $('.pic-item-list');

	form_data.append("pic", file_data);
	form_data.append("module", "stock");
	form_data.append("csrfmiddlewaretoken", Cookies.get("csrftoken"));

  console.log('BEGIN UPLOAD...');
  $('.pic-upload-field input').hide();
  $('.pic-upload-field .loading').show();

	$.ajax({
	  url: postUrl,
    dataType: 'json',
    cache: false,
    contentType: false,
    processData: false,
    data: form_data,
    type: 'post',

    success: function( json ) {
      console.log( 'SUCCESS.', json );
      var oItem = $( '<div class="item" id="id_pics_' + json.pic.id + '"><input style="display: none;" type="checkbox" checked="checked" name="pics" value="' + json.pic.id + '"><img src="' + json.pic.url_thumb + '" alt="" width="100" height="100"><div class="del">X</div></div>' );
      oItem.data('url', json.pic.url);
      oItem.on('click', item_del_onclick);
      $(oPicItemList).prepend( oItem );
    },
    error: function( xhr, status, errorThrown ) {
      console.log( 'ERROR.', xhr, status );
    },
    complete: function( xhr, status ) {
      console.log('UPLOAD COMPLETE.');
      $('.pic-upload-field input').show();
      $('.pic-upload-field .loading').hide();
    },
  });
});

$("#id_stone").select2({
  ajax: {
    url: "{% url 'stonedb_api_search' %}",
    dataType: 'json',
    delay: 250,
    data: function (params) {
      return { q: params.term,  };
    },
    processResults: function (data, params) {
      return { results: data.items, };
    },
    cache: true,
  },
  escapeMarkup: function (markup) { return markup; },
  minimumInputLength: 3,
  maximumSelectionLength: 1,
  templateResult: formatResult,
  templateSelection: formatResultSelection,
});

function formatResult (item) {
  if (item.loading) return item.name;

  return "<div class='select2-result-stones'><div class='pic'><img src='" + item.pic + "'></div><div class='names'><div class='name'>" + item.name + "</div><div class='pseu'> - " + item.pseu + "</div></div></div>";
}

function formatResultSelection (item) {
  return item.text || item.name;
}

</script>

{% endblock %}
